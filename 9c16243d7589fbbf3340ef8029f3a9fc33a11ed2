{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "3bc6dfd9_5f76757b",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1001712
      },
      "writtenOn": "2024-07-31T13:53:11Z",
      "side": 1,
      "message": "looks good. \n\nThis was probably one of the easier easier examples but i see your point of how an integration test like this can be shorter when written in bash.\n\n\nThis however cannot do asan / ubsan on the code. \n\nThe application is not linked to the test so it is just like any other program that is called.\n\nAlso the code from the application cannot be re-used for the test.",
      "revId": "9c16243d7589fbbf3340ef8029f3a9fc33a11ed2",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "7bede628_7def3911",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1000009
      },
      "writtenOn": "2024-08-01T00:34:27Z",
      "side": 1,
      "message": "\u003e This however cannot do asan / ubsan on the code. \n\nCan you unpack your concerns here?\n\nFor reference, in the following gist I introduce a heap overflow, and it it is detected just fine by ASAN:\n\nhttps://gist.github.com/amboar/afe2352080d9280df07f44105b4d7a9f\n\nThis works because the `obmc-console-server` binary is compiled and linked with ASAN support, as requested by `meson setup -Db_sanitize\u003daddress,undefined`, and we invoke the built binary. This goes for `obmc-console-client` as well.\n\n\u003e Also the code from the application cannot be re-used for the test.\n\nAs a maintainer of the code, for test cases like what I\u0027ve demonstrated here, copy/paste isn\u0027t high on my list of concerns. It\u0027s fine. It\u0027s just test code. We can always rework it later if becomes a maintenance concern, which, as a maintainer of obmc-console, is my problem to fix given I\u0027m asking you to create it. Please don\u0027t consider discarding the \"DRY\" principle a blocker to writing shell scripts for the tests.\n\n(A final nit is that the script is written for `sh` and not `bash`. It runs just fine in e.g. the [dash](https://man7.org/linux/man-pages/man1/dash.1.html) shell, which is constrained to the POSIX shell specification. IMO `bash` has a lot of features that allow the implementation to creep into the territory of \"this should not be a shell script\", and should be avoided).",
      "parentUuid": "3bc6dfd9_5f76757b",
      "revId": "9c16243d7589fbbf3340ef8029f3a9fc33a11ed2",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "a141ead7_3fbe1b21",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1001712
      },
      "writtenOn": "2024-08-02T15:07:28Z",
      "side": 1,
      "message": "Well meson has always been hard to grasp for me. Probably it did not work for me in this way because i never specified ```depends: [ server ],```.\n\nThe shell version is really a lot shorter and if asan works then it\u0027s fine with me.\n\nStarted implementing the tests in shell, for some reason some of them still fail in CI, but not when i run them in CI locally. Maybe i need to isolate them even more.\n\nHere\u0027s the patch series: https://gerrit.openbmc.org/c/openbmc/obmc-console/+/73272",
      "parentUuid": "7bede628_7def3911",
      "revId": "9c16243d7589fbbf3340ef8029f3a9fc33a11ed2",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "b7ed0dad_fa095482",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1000009
      },
      "writtenOn": "2024-08-05T01:28:19Z",
      "side": 1,
      "message": "\u003e Well meson has always been hard to grasp for me. Probably it did not work for me in this way because i never specified depends: [ server ],.\n\nIf you have questions about meson I\u0027m happy to have a crack at answering them; but really all I have is experience with bashing my head against it. However, I do find I do less head-bashing with meson than say autotools. The meson documentation tends to be quite good, and the language itself tends to be pretty readable. We need to specify `depends` in this instance to make sure that `obmc-console-server` is actually built before we invoke it in the test...\n\n\u003e Started implementing the tests in shell, for some reason some of them still fail in CI, but not when i run them in CI locally. Maybe i need to isolate them even more.\n\nI\u0027ve looked into this (also based on your DM) and got it sorted; with PS2 `dbus-run-session meson test --repeat 500 -C build test-console-logs-to-file` completes successfully. I\u0027ve made several small tweaks that you can see here:\n\nhttps://gerrit.openbmc.org/c/openbmc/obmc-console/+/73211/1..2/test/test-console-logs-to-file\n\nThe change that addresses the flakiness you found is to add:\n\n```\nwhile ! busctl status --user xyz.openbmc_project.Console.\"${TEST_NAME}\"; do sleep 1; done\n```\n\nI [used strace](https://gerrit.openbmc.org/c/openbmc/obmc-console/+/73308/1/test/meson.build) to understand what was going on. It turned out that while the `obmc-console-server` process had been forked off, in the failing cases it had either not yet `exec`ed from the subshell to the `obmc-console-server` image, or had, but had not completed initialisation before we hit it with `kill -s INT ...`. Essentially it was a lack of control over the scheduling. Ensuring that its initialisation has completed by testing for its presence on DBus lead to much higher reliability.\n\nAnother thing to note in the intra-patch diff is adding support for parallel instances on the one DBus session via `${$}` (the PID of the current shell process). This allows meson\u0027s `--repeat N` to behave correctly.\n\nThe final important difference is I got the test suite name wrong: It should be `itests` (plural) and not `itest` (singular).\n\nI haven\u0027t yet looked at your subsequent test implementations, but I expect you will need to account for these changes too.",
      "parentUuid": "a141ead7_3fbe1b21",
      "revId": "9c16243d7589fbbf3340ef8029f3a9fc33a11ed2",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    }
  ]
}